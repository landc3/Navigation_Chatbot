# 更新线上代码部署指南

## 📋 更新流程概述

当你修改了本地代码并想更新到线上服务器时，需要完成以下步骤：

1. **本地提交代码到GitHub**
2. **在服务器上拉取最新代码**
3. **重新构建并启动Docker容器**

---

## 🚀 快速更新步骤

### 第1步：本地提交代码到GitHub

在你的**本地电脑**上执行：

```powershell
# 进入项目目录
cd C:\Users\Lu\AI-Cursor\Navigation_Chatbot

# 查看修改的文件
git status

# 添加所有修改的文件
git add .

# 提交更改（请填写有意义的提交信息）
git commit -m "添加新功能：描述你的修改内容"

# 推送到GitHub
git push origin master
```

**如果还没有配置Git用户信息：**
```powershell
git config --global user.name "你的名字"
git config --global user.email "你的邮箱"
```

---

### 第2步：在服务器上更新代码

**方法1：通过Workbench更新（推荐）**

1. **打开阿里云Workbench**
   - 访问：https://ecs.console.aliyun.com/
   - 找到你的服务器实例
   - 点击"远程连接" → "Workbench"

2. **打开PowerShell**
   - 点击开始菜单 → 搜索"PowerShell" → 打开

3. **执行更新命令**
   ```powershell
   # 进入项目目录
   cd Navigation_Chatbot
   
   # 拉取最新代码
   git pull origin master
   
   # 查看更新内容
   git log --oneline -5
   ```

**方法2：使用一键更新脚本**

```powershell
# 进入项目目录
cd C:\Navigation_Chatbot

# 执行更新脚本
.\scripts\update_remote.ps1
```

---

### 第3步：重新构建并启动容器

在服务器的PowerShell中执行：

```powershell
# 确保在项目目录中
cd Navigation_Chatbot

# 停止现有容器
docker compose down

# 重新构建并启动（使用最新代码）
docker compose up --build -d

# 查看容器状态
docker ps

# 查看日志确认启动成功
docker compose logs -f
```

**按 `Ctrl+C` 退出日志查看**

---

## ⚡ 一键更新脚本

我已经为你创建了自动更新脚本，可以一键完成所有步骤：

```powershell
# 在服务器上执行
cd C:\Navigation_Chatbot\scripts
.\update_remote.ps1
```

---

## 📝 完整更新流程示例

### 本地操作（你的电脑）

```powershell
# 1. 进入项目目录
cd C:\Users\Lu\AI-Cursor\Navigation_Chatbot

# 2. 查看修改
git status

# 3. 提交并推送
git add .
git commit -m "更新：添加新功能"
git push origin master
```

### 服务器操作（Workbench）

```powershell
# 1. 进入项目目录
cd C:\Navigation_Chatbot

# 2. 拉取最新代码
git pull origin master

# 3. 重新部署
docker compose down
docker compose up --build -d

# 4. 验证
docker ps
```

---

## 🔍 验证更新是否成功

### 方法1：检查容器状态
```powershell
docker ps
```
应该看到容器状态为 `Up`，并且是最近启动的。

### 方法2：查看日志
```powershell
docker compose logs backend
docker compose logs frontend
```
检查是否有错误信息。

### 方法3：访问应用
在浏览器中访问：
- http://101.37.89.207
- http://101.37.89.207:8000/docs

检查新功能是否生效。

---

## ⚠️ 注意事项

### 1. 环境变量不会丢失
`.env` 文件不会被Git跟踪，所以你的API密钥等配置不会丢失。

### 2. 数据库数据（如果有）
如果项目使用了数据库，确保数据已持久化（使用Docker volumes）。

### 3. 前端构建
如果修改了前端代码，Docker会自动重新构建前端镜像。

### 4. 后端代码
如果修改了后端代码，需要重新构建容器才能生效。

---

## 🔧 常见问题

### 问题1：git pull 失败 - 本地有未提交的更改

**错误信息：**
```
error: Your local changes to the following files would be overwritten by merge:
    backend/Dockerfile
    frontend/Dockerfile
Please commit your changes or stash them before you merge.
```

**原因：** 服务器上的本地文件有未提交的修改，与GitHub上的更新冲突。

**解决方法（3种选择）：**

#### 方法1：暂存本地更改（推荐，保留本地修改）

```bash
# 暂存本地更改
git stash

# 拉取最新代码
git pull origin master

# 如果需要恢复本地更改（通常不需要，因为要使用远程版本）
# git stash pop
```

#### 方法2：放弃本地更改，使用远程版本（推荐，如果本地修改不重要）

```bash
# 放弃本地所有更改
git reset --hard HEAD

# 拉取最新代码
git pull origin master
```

#### 方法3：提交本地更改后再合并

```bash
# 提交本地更改
git add .
git commit -m "服务器本地修改"

# 拉取并合并
git pull origin master

# 如果有冲突，解决冲突后：
# git add .
# git commit -m "解决冲突"
```

**推荐使用方法2**，因为服务器上的代码应该与GitHub保持一致。

---

### 问题2：git pull 失败 - 不相关的历史

**错误：** `fatal: refusing to merge unrelated histories`

**解决方法：**
```bash
git pull origin master --allow-unrelated-histories
```

### 问题2：容器启动失败

**检查日志：**
```powershell
docker compose logs backend
docker compose logs frontend
```

**常见原因：**
- 代码语法错误
- 依赖包缺失
- 环境变量配置错误

### 问题3：更新后功能不生效

**解决方法：**
```powershell
# 完全清理并重新构建
docker compose down -v
docker compose build --no-cache
docker compose up -d
```

### 问题4：端口被占用

**检查端口占用：**
```powershell
netstat -ano | findstr :80
netstat -ano | findstr :8000
```

**停止占用端口的进程：**
```powershell
taskkill /PID <进程ID> /F
```

---

## 📋 更新检查清单

- [ ] 本地代码已提交到GitHub
- [ ] 服务器上已拉取最新代码
- [ ] Docker容器已重新构建
- [ ] 容器状态正常（`docker ps`）
- [ ] 应用可以正常访问
- [ ] 新功能已生效

---

## 🎉 更新完成！

更新完成后，你的新功能就会在线上生效了！

**访问地址：**
- 前端应用: http://101.37.89.207
- 后端API: http://101.37.89.207:8000
- API文档: http://101.37.89.207:8000/docs

