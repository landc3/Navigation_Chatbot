# 第2天开发任务 Prompt

## 📅 第2天：核心检索功能开发

### 任务目标
实现核心搜索功能，包括增强的关键词匹配、层级路径利用、结果排序和过滤，为后续的LLM集成和多轮对话打下基础。

---

## 上午任务（4小时）

### 1. 基础搜索功能实现

#### 当前状态
- ✅ 已实现简单的关键词匹配搜索（`DataLoader.search_by_keyword`）
- ✅ 支持在文件名称和层级路径中搜索
- ⚠️ 需要增强：模糊匹配、多关键词搜索

#### 任务清单

##### 1.1 模糊匹配功能
- [ ] 实现部分匹配算法
  - 支持关键词的部分匹配（如"天龙"匹配"天龙KL"）
  - 支持中文分词匹配（使用jieba）
  - 支持拼音匹配（可选，使用pypinyin）
- [ ] 在文件名称中实现模糊匹配
- [ ] 在层级路径中实现模糊匹配

##### 1.2 多关键词搜索
- [ ] 实现关键词提取（从用户输入中提取多个关键词）
- [ ] 实现AND逻辑搜索（所有关键词都必须匹配）
- [ ] 实现OR逻辑搜索（任一关键词匹配即可）
- [ ] 支持混合逻辑（如：关键词1 AND (关键词2 OR 关键词3)）
- [ ] 默认使用AND逻辑，提高精确度

#### 实现位置
- 创建 `backend/app/services/search_service.py`
- 在 `DataLoader` 中扩展搜索方法，或创建独立的搜索服务类

---

### 2. 层级路径解析与利用

#### 当前状态
- ✅ 已实现基础层级路径解析（`CircuitDiagram._parse_hierarchy`）
- ✅ 已提取品牌、型号、类型等信息
- ⚠️ 需要增强：基于层级的筛选、选项统计

#### 任务清单

##### 2.1 层级路径深度解析
- [ ] 增强层级路径解析功能
  - 提取所有层级的完整信息
  - 识别层级类型（类型、类别、品牌、型号、其他属性）
  - 支持动态层级深度
- [ ] 创建层级路径工具类 `HierarchyUtil`

##### 2.2 基于层级的筛选功能
- [ ] 实现按品牌筛选
- [ ] 实现按型号筛选
- [ ] 实现按类型筛选
- [ ] 实现按车辆类别筛选
- [ ] 支持多条件组合筛选

##### 2.3 层级选项统计
- [ ] 从搜索结果中提取可用的品牌选项
- [ ] 从搜索结果中提取可用的型号选项
- [ ] 从搜索结果中提取可用的类型选项
- [ ] 统计各选项的出现次数
- [ ] 按出现次数排序选项
- [ ] 限制选项数量（3-5个）

#### 实现位置
- 创建 `backend/app/utils/hierarchy_util.py`
- 在 `DataLoader` 中添加筛选和统计方法

---

## 下午任务（4小时）

### 3. 检索结果排序与过滤

#### 任务清单

##### 3.1 相关性评分算法
- [ ] 设计评分规则：
  - **完全匹配**：关键词完全匹配（权重：1.0）
  - **部分匹配**：关键词部分匹配（权重：0.7）
  - **文件名称匹配**：在文件名称中匹配（权重：1.0）
  - **层级路径匹配**：在层级路径中匹配（权重：0.5）
  - **品牌匹配**：品牌字段匹配（权重：0.8）
  - **型号匹配**：型号字段匹配（权重：0.9）
- [ ] 实现评分函数 `calculate_relevance_score`
- [ ] 对搜索结果按评分排序（降序）

##### 3.2 结果去重
- [ ] 识别重复结果（基于ID）
- [ ] 保留评分最高的结果
- [ ] 实现去重函数 `deduplicate_results`

##### 3.3 结果限制
- [ ] 实现结果数量限制（默认最多返回N条）
- [ ] 支持自定义限制数量
- [ ] 在返回结果时应用限制

#### 实现位置
- 在 `search_service.py` 中实现评分和过滤逻辑

---

### 4. 测试与优化

#### 任务清单

##### 4.1 使用keywords.txt测试
- [ ] 读取 `keywords.txt` 中的所有搜索关键词
- [ ] 对每个关键词执行搜索
- [ ] 记录搜索结果数量
- [ ] 评估搜索质量（相关性、准确性）
- [ ] 记录问题和改进点

##### 4.2 性能优化
- [ ] 分析搜索性能瓶颈
- [ ] 优化搜索算法（减少循环次数）
- [ ] 考虑使用索引优化（为后续准备）
- [ ] 测试大数据量下的性能

##### 4.3 边界情况处理
- [ ] 处理空关键词
- [ ] 处理特殊字符
- [ ] 处理无结果情况
- [ ] 处理超长关键词

#### 测试文件
- 创建 `backend/test_search_service.py`
- 创建测试用例覆盖各种场景

---

## 代码结构设计

### 新增文件
```
backend/app/
├── services/
│   ├── __init__.py
│   └── search_service.py      # 搜索服务（新增）
├── utils/
│   ├── __init__.py
│   ├── data_loader.py          # 已有，需要扩展
│   └── hierarchy_util.py       # 层级工具（新增）
└── api/
    └── chat.py                 # 需要更新，使用新的搜索服务
```

### 搜索服务接口设计

```python
class SearchService:
    """搜索服务"""
    
    def search(
        self, 
        query: str, 
        logic: str = "AND",  # AND or OR
        max_results: int = 5,
        use_fuzzy: bool = True
    ) -> List[ScoredResult]:
        """
        搜索电路图
        
        Args:
            query: 搜索查询（支持多关键词）
            logic: 逻辑运算符（AND/OR）
            max_results: 最大返回结果数
            use_fuzzy: 是否使用模糊匹配
            
        Returns:
            评分后的结果列表
        """
        pass
    
    def filter_by_hierarchy(
        self,
        results: List[CircuitDiagram],
        brand: str = None,
        model: str = None,
        diagram_type: str = None
    ) -> List[CircuitDiagram]:
        """基于层级路径筛选结果"""
        pass
    
    def extract_options(
        self,
        results: List[CircuitDiagram],
        option_type: str,  # "brand", "model", "type"
        max_options: int = 5
    ) -> List[Dict]:
        """从结果中提取选项（用于选择题）"""
        pass
```

---

## 交付物检查清单

### 必须完成
- [ ] 模糊匹配功能可用
- [ ] 多关键词搜索功能可用（AND/OR逻辑）
- [ ] 层级路径筛选功能可用
- [ ] 层级选项统计功能可用
- [ ] 相关性评分算法实现
- [ ] 结果去重功能实现
- [ ] 结果限制功能实现
- [ ] 使用keywords.txt测试通过
- [ ] 性能满足要求（搜索响应时间<1秒）

### 代码质量要求
- 代码结构清晰，职责分离
- 注释完整，函数有文档字符串
- 错误处理完善
- 遵循Python最佳实践
- 单元测试覆盖主要功能

---

## 开发注意事项

1. **搜索性能**：4235条数据不算太多，但要考虑后续扩展
2. **中文处理**：注意中文分词和编码问题
3. **评分算法**：评分规则要合理，确保最相关的结果排在前面
4. **向后兼容**：保持现有API接口兼容，逐步迁移到新服务
5. **可扩展性**：为后续LLM集成预留接口

---

## 下一步准备

完成第2天后，为第3天做准备：
- 搜索服务要支持意图理解结果作为输入
- 层级选项统计要为选择题生成做准备
- API接口要考虑多轮对话的需求

---

**开始开发！** 🚀

