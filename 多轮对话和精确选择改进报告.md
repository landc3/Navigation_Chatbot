# 多轮对话和精确选择改进报告

## 改进目标

根据项目需求，改进多轮对话功能，使其能够：
1. 当检索结果较多时（>5个），通过选择题形式帮助用户缩小范围
2. 提问方式优先使用选择题，而非开放式问题
3. 基于当前检索结果动态生成选项
4. 匹配更加精确，支持组合选项（如品牌+型号）

## 主要改进内容

### 1. 改进选项提取逻辑 (`backend/app/utils/hierarchy_util.py`)

#### 1.1 支持组合选项提取
- 新增 `brand_model` 选项类型，支持提取品牌+型号组合选项（如"东风天龙 KL"）
- 新增 `_extract_enhanced_model()` 方法，从文件名称和层级路径中提取更详细的型号信息
- 改进 `extract_options()` 方法，支持组合选项提取

#### 1.2 改进型号筛选逻辑
- 优化 `filter_by_model()` 方法，支持精确匹配和模糊匹配
- 支持反向包含匹配（如"KL"匹配"天龙KL"）

### 2. 优化问题生成服务 (`backend/app/services/question_service.py`)

#### 2.1 智能选项生成策略
- 当用户已选择品牌时，优先使用品牌+型号组合选项
- 按优先级尝试生成问题：品牌+型号组合 -> 品牌 -> 型号 -> 类型 -> 类别
- 当单一维度选项不足时，自动尝试组合维度

#### 2.2 改进问题文本生成
- 优化 `_generate_question_text()` 方法，根据上下文生成更自然的问题
- 支持根据筛选历史生成个性化问题文本

### 3. 改进筛选逻辑 (`backend/app/services/search_service.py`)

#### 3.1 支持品牌+型号组合筛选
- 新增 `_parse_brand_model()` 方法，解析品牌+型号组合选项值
- 支持从选项值中提取品牌和型号信息

### 4. 优化对话流程 (`backend/app/api/chat.py`)

#### 4.1 改进选择题生成逻辑
- 当结果>5个时，必须生成选择题
- 改进fallback逻辑：当标准方法无法生成选择题时，尝试从层级路径中提取更细粒度的选项
- 支持品牌+型号组合选项的筛选

#### 4.2 优化筛选处理
- 支持处理 `brand_model` 类型的选项选择
- 当用户选择品牌+型号组合时，同时筛选品牌和型号

### 5. 优化LLM问题生成 (`backend/app/services/llm_service.py`)

#### 5.1 改进问题生成Prompt
- 添加更详细的示例风格说明
- 支持 `brand_model` 类型的问题生成
- 优化问题文本，使其更符合示例对话的风格

## 改进效果

### 改进前的问题
1. 当检索结果>5个时，可能无法生成选择题，直接返回前5个结果
2. 选项提取不够精确，无法提取组合选项（如"东风天龙 KL"）
3. 筛选逻辑不够精确，可能导致匹配不准确

### 改进后的效果
1. ✅ **强制生成选择题**：当结果>5个时，必须生成选择题，如果标准方法失败，会尝试fallback方法
2. ✅ **支持组合选项**：能够提取品牌+型号组合选项（如"东风天龙 KL"、"东风天龙 KC"等）
3. ✅ **更精确的匹配**：改进筛选逻辑，支持精确匹配和模糊匹配
4. ✅ **更自然的问题**：LLM生成的问题更符合示例对话的风格

## 示例对话流程

### 改进后的对话示例

```
用户：我要一个东风天龙的仪表图
Chatbot：我找到了东风天龙相关的电路图。请问您需要的是：
A. 东风天龙 KL 系列
B. 东风天龙 KC 系列
C. 东风天龙 VL 系列

用户：A
Chatbot：明白了。请问您需要的是哪种类型的仪表电路图：
A. ECU 仪表针脚图
B. 整车仪表线路图

用户：整车仪表线路图
Chatbot：已为您找到以下电路图：
[ID: 12345] 东风天龙KL整车仪表电路图
```

## 技术细节

### 选项提取优先级
1. 如果用户已选择品牌 → 优先使用品牌+型号组合
2. 否则 → 按优先级尝试：品牌 -> 型号 -> 品牌+型号 -> 类型 -> 类别

### 筛选逻辑
- 品牌筛选：支持精确匹配和包含匹配
- 型号筛选：支持精确匹配、包含匹配和反向包含匹配
- 品牌+型号组合：同时筛选品牌和型号

### Fallback机制
当标准方法无法生成选择题时：
1. 尝试从层级路径中提取不同层级的选项
2. 按优先级检查：品牌 -> 型号 -> 类型 -> 类别
3. 如果找到有多个选项的层级，生成选择题
4. 如果仍然无法生成，返回前5个结果

## 文件修改清单

1. `backend/app/utils/hierarchy_util.py`
   - 改进 `extract_options()` 方法
   - 新增 `_extract_enhanced_model()` 方法
   - 改进 `filter_by_model()` 方法

2. `backend/app/services/question_service.py`
   - 改进 `generate_question()` 方法
   - 新增 `_extract_brand_model_options()` 方法
   - 改进 `_generate_question_text()` 方法

3. `backend/app/services/search_service.py`
   - 新增 `_parse_brand_model()` 方法

4. `backend/app/api/chat.py`
   - 改进选择题生成逻辑
   - 支持品牌+型号组合筛选
   - 改进fallback逻辑

5. `backend/app/services/llm_service.py`
   - 改进问题生成Prompt
   - 支持 `brand_model` 类型

## 测试建议

1. **测试组合选项提取**
   - 输入："我要一个东风天龙的仪表图"
   - 预期：能够提取出"东风天龙 KL"、"东风天龙 KC"等组合选项

2. **测试多轮对话**
   - 输入："我要一个东风天龙的仪表图"
   - 选择："A"（东风天龙 KL）
   - 预期：继续生成类型选择题

3. **测试精确匹配**
   - 输入："东风天龙KL仪表图"
   - 预期：能够精确匹配到"东风天龙 KL"相关的电路图

4. **测试Fallback机制**
   - 输入一个会产生很多结果但选项提取困难的查询
   - 预期：仍然能够生成选择题，而不是直接返回结果

## 后续优化建议

1. 进一步优化选项提取算法，支持更多组合维度
2. 改进LLM问题生成，使其更加自然和个性化
3. 添加选项去重和合并逻辑，避免选项过于相似
4. 优化筛选性能，提高响应速度



