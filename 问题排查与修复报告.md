## 问题排查与修复报告（Excel 文档索引检索 + 多轮筛选）

### 背景
用户在“文档/文件名列表（如 Excel 或知识库索引）”中搜索资料。系统需要从候选数据中筛出**最符合用户意图**的条目；当存在歧义时，通过**多轮澄清**逐层收敛，直到可以稳定返回结果。

---

## 1）问题与验收标准

### 1.1 关键词 AND 筛选不严格（返回过多不相关结果）
- **用户输入示例**：“我要 **东风天龙** **仪表针脚图**”
- **当前问题**：返回了 5 条，但真正符合的是：**文件名同时包含**“东风天龙”与“仪表针脚图”的条目（示例中仅第 3、4 条）。
- **期望行为（规则）**
  - **硬条件（AND）**：对用户明确给出的核心关键词，候选结果必须**同时满足**（例如：车型=东风天龙 AND 主题=仪表针脚图）。
  - **排序优先级**：命中越多“硬条件”的排越前；只命中其中一部分的应降权，必要时不返回。
- **验收标准**
  - 当用户输入同时包含多个明确关键词时，返回结果应以“全命中 AND”为主；不得把“只命中部分关键词”的结果混在前几条里误导用户。

### 1.2 缺少“同义/包含”匹配（漏召回）
- **用户输入示例**：“东风天龙的 **仪表图**”
- **当前问题**：只返回 2 条，但应额外包含：“东风_天龙_天锦_仪表_电路图.DOCX”
- **原因**：“**仪表电路图**”对用户来说属于“**仪表图**”的下位表达（包含/近义关系）。
- **期望行为（规则）**
  - **等价/包含匹配**：当用户用更宽泛词（如“仪表图”）时，应能召回其常见具体化表达（如“仪表电路图”“仪表线路图”“仪表接线图”等）。
  - **实现方式建议**
    - 维护可配置的“词族/同义词/包含关系”表（例如：仪表图 ⟶ {仪表电路图, 仪表线路图, 仪表接线图, …}）。
    - 对文件名做规范化（下划线/空格/大小写/全半角/括号等统一）后再匹配。
- **验收标准**
  - 对“仪表图”这类上位词，系统能稳定召回其常见下位词文件名；漏掉上述示例文件视为失败。

### 1.3 缺少多轮澄清（车型/版本/配置歧义时一次性给错/给不全）
- **用户输入示例**：“我要找 **东风天龙 牵引车**”
- **数据特点**：候选可能同时存在“东风天龙 / 天龙KL / 天龙VL …”，且“牵引车”又可细分“4X2 / 6X2 …”等配置。
- **期望行为（多阶段筛选 + 多轮选择）**
  - **筛选 1（粗筛）**：先从全量数据中筛出**同时包含**“东风天龙”与“牵引车”的候选集合（AND）。
  - **澄清 1（车型子系列）**：若候选存在多个子系列（如：东风天龙 / KL / VL / …），先让用户选择（或“不限”）。
  - **澄清 2（配置/轴型等）**：用户选定子系列后，再让用户在细分项中选择（如：4X2 / 6X2 / 不限）。
  - **继续澄清（可选）**：仍存在关键差异（年份/排放/版本号…）时，按同样方式继续分层询问。
  - **终止条件**：候选集已足够小（例如 ≤ N 条）且差异不再关键时，直接返回结果。
- **验收标准**
  - 对存在明显分支（子系列/配置）的查询，系统会优先发起“选择题式澄清”，而不是直接返回一堆混杂结果。
  - 澄清后返回的结果来自“逐层收敛后的候选集”，且每一步可解释（为什么筛到这些）。

---

## 2）功能规格（面向落地实现）

### 2.1 数据字段约定（Excel）
- **必需字段**
  - **ID**：唯一标识（用于最终返回与用户选择）
  - **标题/名称**：用于检索（通常包含品牌/车型/类型/版本等）
- **推荐字段（可选）**
  - **品牌/厂商**、**车系/车型**、**系统/部位**（仪表/ECU/线束…）、**文档子类型**（整车电路图/仪表电路图/针脚图/概述…）、**排放/年份/配置**（国五/2012款/6x4…）

### 2.2 基本策略（必须遵守）
- **硬条件（AND）优先**：用户明确说出的核心词，候选必须尽量全命中（同一行或同一行拼接文本）。
- **软匹配扩展**：对上位词/宽泛词用“同义/包含”扩展召回（可配置）。
- **宁可少而准**：在歧义未澄清前，避免把大量结果直接丢给用户。

### 2.3 结果数量门槛（建议默认 N=5）
- **0 条**：追问缺失信息（品牌/车型/文档子类型/年份排放…），并给可选提示。
- **1 条**：直接返回 `[ID] 标题`。
- **2–5 条**：列清单（序号 + ID + 标题），让用户选序号或 ID。
- **>5 条**：进入二级筛选（分组 + 选择题澄清）。

---

## 3）分层筛选流程（用你的两个例子校验）

### 3.1 解析与规范化（NLU + Normalize）
从用户一句话尽量提取这些槽位：
- **品牌/厂商**：东风/福田/江淮…
- **车系/车型**：天龙KL、凯普特D28、瑞风M5、时代康瑞H1…
- **控制器/代号**：C81、EDC17C81、D320…
- **文档类型（上位）**：电路图/线路图/接线图/针脚图/概述…
- **文档子类型（下位）**：整车电路图/仪表电路图/ECU针脚图/线束布置/部件位置…
- **系统/部位**：仪表/ECU/发动机/车身/ABS…
- **约束词**：国五/国四/2012款/6x4/环卫车/牵引车…

规范化建议：
- **字符归一**：全半角、大小写、空格/下划线、常见符号（括号/中括号/顿号等）。
- **代号归一**：例如把“EDC17 C81 / EDC17C81”统一成同一写法后再匹配。

### 3.2 一级筛选（粗筛）
- **构造硬关键词集合 K_hard**：来自已抽取槽位（按强约束优先）
  - 控制器代号（如 C81/EDC17C81） > 车型/车系（如 天龙KL） > 品牌（如 东风） > 文档类型（如 电路图） > 其他约束（国五/年份/6x4…）
- **构造软扩展集合 K_soft**：仅对上位词做扩展（例如“仪表图”扩展到“仪表电路图/仪表线路图/仪表接线图…”）
- **匹配规则**：优先用 K_hard 做 AND；必要时再叠加 K_soft 提升召回，但仍保持排序与澄清机制。

### 3.3 二级筛选（当候选 > 5 时必须做）
- **类型直返规则（关键）**：如果用户需求包含“电路图”，且候选按“文档子类型”统计后只剩一种子类型并且是**整车电路图**，则无需再问“你要哪种电路图”，直接进入返回/列表。
- **否则分组澄清**：按“用户最容易理解”的维度分组提问（优先级）
  - **品牌 + 车系/车型前缀**（标题里通常最明显）
  - **车型配置**（如 6x4 环卫车 / 6x4 牵引车）
  - **文档子类型**（整车/仪表/针脚/概述/线束布置…）
  - **排放/年份**（国四/国五/2012款…）

澄清输出格式（必须带数量）：
- “我找到了 N 条，先帮您缩小范围：A. 组1（x条）B. 组2（y条）… 请回复 A/B/C 或直接输入组名关键词。”

### 3.4 例子校验
- **例子1：天龙KL 电路图**
  - 一级筛选：AND `{天龙KL, 电路图}` → 10 条
  - 二级分组（车型前缀）：东风天龙KL_6x4环卫车（4）/ 东风天龙KL（1）/ 东风天龙KL_6x4牵引车（3）/ 东风新天龙KL（1）/ 东风新天龙KL_D320（1）
  - 用户选组后：若该组只剩“整车电路图”，触发**类型直返规则**直接返回（或 ≤5 列表）
- **例子2：C81 电路图**
  - 一级筛选：AND `{C81, 电路图}` → 6 条（>5）
  - 二级分组（品牌+车型）：福田奥铃_493（1）/ 福田_时代康瑞H1（2）/ 江淮_瑞风M5（2）/ 东风_凯普特D28_国四（1）
  - 用户选组后：每组 ≤5，可直接返回或给清单让选

---

## 4）伪代码/函数设计（给 AI 直接补全实现）

```pseudo
function handle_user_query(user_text, excel_rows, config):
    slots = parse_slots(user_text, config)            # 品牌/车型/代号/类型/约束…
    query = build_query(slots, config)                # hard_terms, soft_terms, intent
    candidates = filter_rows(excel_rows, query)       # 先 hard AND，再按需 soft 扩展
    ranked = rank_candidates(candidates, query)       # 全命中优先，其次命中数与权重

    if ranked.size == 0:
        return ask_for_missing_info(slots, config)
    if ranked.size == 1:
        return return_single(ranked[0])
    if ranked.size <= config.max_direct_list:         # 默认 5
        return return_list_for_choice(ranked)

    # ranked.size > 5: 进入二级筛选/澄清
    if should_direct_return_by_doc_type(slots, ranked, config):
        narrowed = apply_doc_type_filter(ranked, config)   # 例如只剩整车电路图
        return narrowed.size == 1 ? return_single(narrowed[0]) : return_list_for_choice(narrowed)

    groups = group_candidates(ranked, priority=[brand_model, config_variant, doc_subtype, emission_year])
    return ask_user_to_choose_group(groups)
```

---

## 5）可直接复制给 AI 的 Prompt（系统/开发者消息）

> 用法：把下面整个代码块复制给 AI，并把其中的“Excel列名/字段”替换为你的真实列名。

```text
你是“资料检索与导航助手”。你要在 Excel 的文档索引（每行一个文件）里做检索与多轮澄清，目标是返回最符合用户意图的 1 条或少量条目，并在歧义时通过选择题逐层缩小范围。

【数据约定】
- Excel 每行至少包含：ID(唯一)、标题/名称(可检索)。
- 可选字段：品牌、车系/车型、系统/部位、文档子类型（整车电路图/仪表电路图/针脚图/概述/线束布置/部件位置）、排放/年份/配置等。
- 检索文本可使用：拼接文本 = 标题 + 品牌 + 车型 + 文档子类型 + 备注（如有）。

【必须遵守的匹配规则】
1) 规范化：对用户文本与行文本做统一规范化（全半角、大小写、空格/下划线、常见符号；并把如“EDC17 C81/EDC17C81”归一）。
2) 硬条件 AND：用户明确说出的核心关键词尽量作为硬条件 AND（同一行必须同时命中）。全命中优先。
3) 软扩展：仅当用户使用上位词/宽泛词（如“仪表图”）时，用可配置的“同义/包含词族”扩展召回（如：仪表图 -> {仪表电路图, 仪表线路图, 仪表接线图, ...}），但仍需保持排序与澄清机制。
4) 排序：优先排序“硬条件全命中”的结果；其次按命中硬条件数量与权重排序。

【结果数量门槛（默认 max_direct_list=5）】
- 0 条：追问缺失信息（优先：品牌/车型/文档子类型/年份排放），并给可选提示。
- 1 条：直接返回：[ID] 标题。
- 2–5 条：列出清单（序号+ID+标题），让用户选序号或 ID。
- >5 条：必须进入二级筛选（分组澄清）。

【二级筛选（分组澄清）】
1) 类型直返规则（关键）：如果用户需求包含“电路图”，且候选按“文档子类型”统计后只剩一种子类型并且是“整车电路图”，则不要再问类型，直接进入返回/列表。
2) 否则按优先级分组并提问（每个选项必须带数量）：
   - 品牌 + 车系/车型前缀
   - 车型配置（如 6x4 环卫车 / 6x4 牵引车）
   - 文档子类型（整车/仪表/针脚/概述/线束布置…）
   - 排放/年份（国四/国五/2012款…）
3) 用户可用 A/B/C 或直接输入组名关键词选择。选定后在组内继续递归：若仍 >5，继续下一维度分组；直到 <=5。

【对话输出要求】
- 需要澄清时：只输出“澄清问题 + A/B/C选项（含数量）”，不要同时输出大量结果干扰用户。
- 可直接返回时：输出 [ID] 标题；如果输出多条，给序号并提示“回复序号或 ID”。

【请你补全实现细节】
- 给出：函数设计、伪代码/关键算法、如何从标题抽取品牌/车型前缀用于分组、如何解析用户选择(A/B/C 或关键词)、以及至少 3 段示例对话（覆盖：AND严格匹配、同义扩展、分层澄清）。
```
